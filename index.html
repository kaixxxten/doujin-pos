<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒäººå ´ POS æ”¶éŠ€ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        /* ä¸»å°èˆª */
        .main-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .main-nav h1 {
            font-size: 1.5rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-btn.active {
            background: white;
            color: #667eea;
        }

        /* é é¢å®¹å™¨ */
        .page {
            display: none;
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ========== éŠ·å”®é é¢ ========== */
        .sales-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* å·¦å´ï¼šè³¼ç‰©è»Š */
        .cart-panel {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .cart-item {
            background: #f9f9f9;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .cart-item-price {
            color: #666;
            font-size: 0.9rem;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .qty-btn:hover {
            background: #f0f0f0;
        }

        .cart-item-qty {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .cart-summary {
            border-top: 2px solid #ddd;
            padding: 1rem;
            background: #fafafa;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .summary-row.total {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            padding-top: 0.5rem;
            border-top: 2px solid #ddd;
        }

        .cart-actions {
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-clear {
            background: #ff4757;
            color: white;
        }

        .btn-clear:hover {
            background: #e84142;
        }

        .btn-checkout {
            background: #667eea;
            color: white;
        }

        .btn-checkout:hover {
            background: #5568d3;
        }

        .btn-checkout:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* å³å´ï¼šå•†å“å±•ç¤º */
        .products-panel {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .filter-bar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-group {
            margin-bottom: 0.75rem;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .product-card.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .product-card.out-of-stock:hover {
            transform: none;
        }

        .product-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .product-info {
            padding: 0.75rem;
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            height: 2.4em;
            overflow: hidden;
        }

        .product-price {
            color: #667eea;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .product-stock {
            font-size: 0.85rem;
            color: #666;
        }

        .product-stock.low {
            color: #ff4757;
            font-weight: bold;
        }

        /* ========== ç®¡ç†é é¢ ========== */
        .manage-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .manage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .manage-header h2 {
            font-size: 1.8rem;
            color: #333;
        }

        .btn-add {
            background: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-add:hover {
            background: #5568d3;
        }

        /* å•†å“è¡¨æ ¼ */
        .products-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #667eea;
            color: white;
        }

        th, td {
            padding: 1rem;
            text-align: left;
        }

        th {
            font-weight: bold;
        }

        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        tbody tr:hover {
            background: #f0f0f0;
        }

        .product-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            font-size: 0.85rem;
        }

        .btn-edit {
            background: #ffa502;
            color: white;
        }

        .btn-delete {
            background: #ff4757;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 0.5rem;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-cancel {
            background: #ccc;
            color: #333;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-save {
            background: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        /* çµå¸³ Modal */
        .checkout-modal .modal-content {
            max-width: 500px;
        }

        .checkout-summary {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .checkout-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .checkout-row.total {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            padding-top: 0.5rem;
            border-top: 2px solid #ddd;
        }

        .quick-cash {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .quick-cash-btn {
            padding: 1rem;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        .quick-cash-btn:hover {
            background: #e0e0e0;
        }

        .change-display {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }

        .change-label {
            font-size: 1rem;
            color: #155724;
            margin-bottom: 0.5rem;
        }

        .change-amount {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
        }

        .gift-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            color: #856404;
            font-weight: bold;
        }

        /* ========== å ±è¡¨é é¢ ========== */
        .report-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .transactions-list {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .transaction-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .transaction-time {
            color: #666;
            font-size: 0.9rem;
        }

        .transaction-total {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .transaction-items {
            color: #666;
            font-size: 0.9rem;
        }

        /* æ»¿é¡è´ˆè¨­å®š */
        .gift-settings {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sales-container {
                flex-direction: column;
            }

            .cart-panel {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .manage-container, .report-container {
                padding: 1rem;
            }

            .products-table {
                overflow-x: auto;
            }
        

            /* æ‰‹æ©Ÿå°è¦½åˆ—æ”¶åˆ */
            .nav-toggle {
                display: none;
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.35);
                color: white;
                padding: 0.45rem 0.7rem;
                border-radius: 10px;
                cursor: pointer;
                font-size: 1.1rem;
            }

            .mobile-menu {
                display: none;
                position: fixed;
                top: 62px;
                right: 10px;
                z-index: 1200;
                background: white;
                border-radius: 14px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                overflow: hidden;
                min-width: 160px;
            }

            .mobile-menu.active { display: block; }

            .mobile-menu-btn {
                width: 100%;
                text-align: left;
                padding: 0.9rem 1rem;
                border: none;
                background: white;
                cursor: pointer;
                font-size: 1rem;
            }
            .mobile-menu-btn:hover { background: #f2f2f2; }

            .main-nav {
                padding: 0.65rem 0.8rem;
            }
            .main-nav h1 {
                font-size: 1.05rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 70vw;
            }
            .nav-buttons { display: none; }
            .nav-toggle { display: inline-flex; align-items: center; }

}
    

/* æ‰‹æ©Ÿç‰ˆï¼šå£“ç¸®è³¼ç‰©è»Šå€ï¼ˆä¸æ”¹çµæ§‹ï¼Œåªè¦†è“‹æ¨£å¼ï¼‰ */
@media (max-width: 768px) {
  .sales-container { height: calc(100vh - 70px); }

  .cart-panel {
    height: 28vh !important;
    min-height: 220px !important;
  }

  .cart-header { padding: 0.6rem 0.8rem !important; font-size: 1rem !important; }
  .cart-items { padding: 0.6rem 0.8rem !important; }

  .cart-item {
    padding: 0.45rem 0.6rem !important;
    margin-bottom: 0.35rem !important;
    border-radius: 8px !important;
  }
  .cart-item-name { font-size: 0.95rem !important; margin-bottom: 0.15rem !important; }
  .cart-item-price { font-size: 0.85rem !important; }

  .cart-summary { padding: 0.6rem 0.8rem !important; }
  .summary-row { margin-bottom: 0.35rem !important; font-size: 0.95rem !important; }
  .summary-row.total { font-size: 1.2rem !important; padding-top: 0.35rem !important; }

  .cart-actions { padding: 0.6rem 0.8rem !important; gap: 0.5rem !important; }
  .btn { padding: 0.65rem !important; font-size: 0.95rem !important; border-radius: 10px !important; }
}

/* ===== v1.2ï¼šæ‰‹æ©Ÿå†å£“æ‰ï¼ˆåˆ†é¡/ç´°é …æ›´çœç©ºé–“ + é¦–é éš±è—è³¼ç‰©è»Šæ˜ç´° + çµå¸³é¡¯ç¤ºæ˜ç´°ï¼‰ ===== */
@media (max-width: 768px) {
  /* ç¯©é¸å€æ›´æ‰ */
  .filter-bar{
    padding: 10px !important;
    margin-bottom: 10px !important;
  }
  .filter-label{
    font-size: 13px !important;
    margin-bottom: 6px !important;
    line-height: 1.1 !important;
  }
  .filter-group{ margin-bottom: 10px !important; }

  /* ä½œå“åˆ†é¡/å•†å“é¡å‹ï¼šå›ºå®šæ©«å‘æ»‘å‹•ï¼ˆå»¶çºŒ v1.1ï¼‰ */
  #categoryFilters,
  #typeFilters{
    display:flex !important;
    flex-wrap:nowrap !important;
    overflow-x:auto;
    gap:6px;
    padding-bottom:4px;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  #categoryFilters::-webkit-scrollbar,
  #typeFilters::-webkit-scrollbar{ display:none; }
  #categoryFilters .filter-btn,
  #typeFilters .filter-btn{
    flex:0 0 auto;
    white-space:nowrap;
    padding:5px 9px !important;
    font-size:12px !important;
    border-width:1px !important;
    border-radius:999px;
  }

  /* é¦–é è³¼ç‰©è»Šï¼šä¸é¡¯ç¤ºæ˜ç´°æ¸…å–®ï¼ˆä¿ç•™ç¸½æ•¸/ç¸½è¨ˆ/æŒ‰éˆ•ï¼‰ */
  .cart-items{ display:none !important; }
  .cart-summary{ border-top:none !important; }
}

/* çµå¸³å½ˆçª—ï¼šç™¼ç¥¨å¼æ˜ç´° */
.checkout-items{
  background:#fff;
  border:2px solid #eee;
  border-radius:10px;
  padding:10px;
  margin-bottom:12px;
  max-height:180px;
  overflow:auto;
  font-size:14px;
}
.checkout-item-row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:6px 0;
  border-bottom:1px dashed #eee;
}
.checkout-item-row:last-child{ border-bottom:none; }
.checkout-item-name{ font-weight:600; }
.checkout-item-sub{ color:#666; font-size:12px; }


/* ===== v1.3ï¼šæ‰‹æ©Ÿæ›´æ‰ï¼ˆè³¼ç‰©è»Šå€ä¸å›ºå®šé«˜åº¦ã€æŒ‰éˆ•å¾€ä¸Šæ”¶ã€æ¸›å°‘ç©ºç™½ï¼‰ ===== */
@media (max-width: 768px) {
  /* è³¼ç‰©è»Šå€ï¼šå–æ¶ˆå›ºå®š vh é«˜åº¦ï¼Œè®“å®ƒè·Ÿå…§å®¹ä¸€èµ·ç¸® */
  .cart-panel{
    height: auto !important;
    min-height: 0 !important;
  }

  /* è³¼ç‰©è»Šæ¨™é¡Œã€ç¸½è¨ˆå€ã€æŒ‰éˆ•å€å†ç¸® */
  .cart-header{
    padding: 8px 10px !important;
    font-size: 16px !important;
  }
  .cart-summary{
    padding: 8px 10px !important;
  }
  .summary-row{
    margin-bottom: 6px !important;
    font-size: 15px !important;
  }
  .summary-row.total{
    font-size: 18px !important;
    padding-top: 6px !important;
    border-top-width: 1px !important;
  }

  .cart-actions{
    padding: 8px 10px !important;
    gap: 8px !important;
  }
  .btn{
    padding: 10px 12px !important;
    font-size: 16px !important;
    border-radius: 12px !important;
  }

  /* è³¼ç‰©è»Šèˆ‡ç¯©é¸å€ä¹‹é–“çš„åˆ†éš”æ›´è–„ã€è·é›¢æ›´è¿‘ */
  .products-panel{ padding-top: 10px !important; }
  .filter-bar{ margin-top: 0 !important; }
}


/* ===== v1.4ï¼šé¿å…æ‰‹æ©Ÿé»æ“Šè‡ªå‹•æ”¾å¤§ï¼ˆé›™æ“Šç¸®æ”¾/è¼¸å…¥æ¡†è‡ªå‹•ç¸®æ”¾ï¼‰ ===== */
.product-card, .filter-btn, .qty-btn, .remove-btn, .btn, .nav-btn, .nav-toggle, .mobile-menu-btn{
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

@media (max-width: 768px){
  /* iOSï¼šé»åˆ°è¼¸å…¥æ¡†/ä¸‹æ‹‰å¯èƒ½è‡ªå‹•æ”¾å¤§ï¼Œå¼·åˆ¶å­—ç´š >= 16px */
  input, select, textarea{
    font-size: 16px !important;
  }
}


/* ===== v1.5Aï¼šæ–¹æ¡ˆAï¼ˆä½œå“+é¡å‹åˆä½µæˆä¸€æ’tagï¼‰ + æ‰‹æ©Ÿæ©«å‘é¡¯ç¤ºé¡PCé›™æ¬„ ===== */

/* æ–¹æ¡ˆAï¼šæ‰‹æ©Ÿæ™‚æŠŠã€Œä½œå“åˆ†é¡ + å•†å“é¡å‹ã€åˆä½µæˆåŒä¸€æ’å¯æ»‘å‹•tag */
@media (max-width: 768px){
  /* éš±è—å…©å€‹æ¨™é¡Œï¼Œçœé«˜åº¦ */
  .filter-label{ display:none !important; }

  /* æŠŠå…©å€‹ filter-group çš„ block æ„Ÿæ¶ˆæ‰ï¼Œè®“è£¡é¢çš„ buttons å¯ä»¥åŒæ’ */
  .filter-group{ display: contents; }

  /* è®“æ•´å€‹ filter-bar è®Šæˆä¸€æ’å¯æ»‘å‹•å®¹å™¨ */
  .filter-bar{
    display:flex !important;
    flex-wrap: nowrap !important;
    overflow-x: auto;
    gap: 6px;
    padding: 10px !important;
    margin-bottom: 10px !important;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .filter-bar::-webkit-scrollbar{ display:none; }

  /* å…©çµ„æŒ‰éˆ•çœŸçš„åˆä½µæˆåŒä¸€æ’ï¼šè®“å…§éƒ¨æŒ‰éˆ•ç›´æ¥æˆç‚º .filter-bar çš„å­å…ƒç´  */
  #categoryFilters, #typeFilters{
    display: contents !important;
  }
/* tag æŒ‰éˆ•æ›´æ‰ã€ä¸å¯æ›è¡Œ */
  .filter-btn{
    flex: 0 0 auto;
    white-space: nowrap;
    padding: 5px 10px;
    font-size: 13px;
    border-radius: 999px;
  }
}

/* æ‰‹æ©Ÿæ©«å‘ï¼šæ”¹æˆé¡PCé›™æ¬„ï¼ˆå·¦è³¼ç‰©è»Š / å³å•†å“ï¼‰ */
@media (max-width: 1024px) and (orientation: landscape){
  .sales-container{
    flex-direction: row !important;
    height: calc(100vh - 70px); /* é ç•™ä¸Šæ–¹å°è¦½åˆ— */
  }
  .cart-panel{
    width: 38% !important;
    height: auto !important;
    border-right: 1px solid #ddd !important;
    border-bottom: none !important;
  }
  .products-panel{
    width: 62% !important;
  }
}


/* v1.5A_fixï¼šfilterå›ºå®šåœ¨ä¸Šæ–¹ */
.filter-bar{
  position: sticky;
  top: 0;
  z-index: 50;
  background: #fff;
}


/* v1.5A_landscapeï¼šæ‰‹æ©Ÿæ©«å¼æ™‚é¡¯ç¤ºè³¼ç‰©æ¸…å–®ï¼ˆç›´å¼ç¶­æŒéš±è—/ç°¡æ½”ï¼‰ */
@media (max-width: 1024px) and (orientation: landscape){
  .cart-items{
    display: block !important;
  }
  /* æ©«å¼å·¦æ¬„é«˜åº¦æœ‰é™ï¼Œè®“æ¸…å–®å¯æ»¾å‹• */
  .cart-items{
    max-height: 42vh;
    overflow: auto;
  }
}


/* v1.5A_cart_compactï¼šè³¼ç‰©è»Šæ¸…å–®ç¸®å°ï¼ˆæ›´çœç©ºé–“ï¼‰ */

/* å•†å“åˆ—é«˜åº¦ç¸®å° */
.cart-item{
  padding: 6px 8px !important;
  font-size: 13px !important;
}

/* å•†å“åç¨± */
.cart-item-name{
  font-size: 13px !important;
}

/* åƒ¹æ ¼ */
.cart-item-price{
  font-size: 12px !important;
}

/* æŒ‰éˆ•ç¸®å° */
.cart-item button{
  padding: 2px 6px !important;
  font-size: 12px !important;
}

/* æ•¸é‡å­— */
.cart-item-qty{
  font-size: 13px !important;
}

/* æ•´é«”æ¸…å–®å†å£“ç¸® */
.cart-items{
  gap: 4px !important;
}

/* æ©«å¼å†æ›´ç·Šæ¹Š */
@media (max-width: 1024px) and (orientation: landscape){
  .cart-item{
    padding: 4px 6px !important;
  }
  .cart-items{
    max-height: 38vh !important;
  }
}


/* v1.6 å¡ç‰‡è³‡è¨Šæ”¹æˆã€Œå·¦åç¨± / å³(åƒ¹æ ¼+åº«å­˜)ã€åŒä¸€åˆ— */
.product-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap: 10px;
}
.product-right{
  text-align:right;
  min-width: 92px;
}
.product-right .product-price{
  margin:0 !important;
}
.product-right .product-stock{
  margin-top: 4px !important;
}


/* v1.6.1 ä¿®æ­£ï¼šé¿å…åº«å­˜æ–‡å­—è¢«è£åˆ‡ï¼ˆå•†å“è³‡è¨Šåˆ—æ”¹æ©«æ’å¾Œï¼‰ */
.product-info{
  padding-bottom: 0.95rem !important; /* å¤šç•™ä¸€é»åº•éƒ¨ç©ºé–“ */
}

.product-row{
  align-items: flex-start;
}

/* åç¨±åœ¨æ©«æ’æ™‚æ”¹ç‚ºå–®è¡Œçœç•¥ï¼Œå–æ¶ˆåŸæœ¬å›ºå®šé«˜åº¦ï¼ˆåŸæœ¬æœƒåƒæ‰é«˜åº¦/å½±éŸ¿æ’ç‰ˆï¼‰ */
.product-row .product-name{
  height: auto !important;
  margin-bottom: 0 !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* å³å´å…©è¡Œæ›´ç·Šæ¹Šï¼Œé¿å…è¢«å¡ç‰‡åº•éƒ¨è£åˆ‡ */
.product-right .product-price{
  line-height: 1.05;
}
.product-right .product-stock{
  line-height: 1.1;
  margin-top: 2px !important;
}


/* ===== å³ä¸Šè§’æœå°‹æŒ‰éˆ• + æœå°‹æµ®å±¤ ===== */
.nav-search{
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 0.5rem 0.75rem;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1.1rem;
}
.nav-search:active{ transform: scale(0.98); }

.search-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  z-index: 999;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 90px 12px 12px; /* é¿é–‹é ‚éƒ¨å°è¦½åˆ— */
}
.search-box{
  width: 100%;
  max-width: 520px;
  background: #fff;
  border-radius: 16px;
  padding: 14px 14px 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
}
.search-title{
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 10px;
}
.search-row{
  display:flex;
  gap: 8px;
  align-items:center;
}
#navSearchInput{
  flex: 1;
  padding: 10px 12px;
  border: 2px solid #eee;
  border-radius: 12px;
  font-size: 16px; /* é¿å… iOS è‡ªå‹•æ”¾å¤§ */
  outline: none;
}
#navSearchInput:focus{
  border-color: #ffd54f;
  box-shadow: 0 0 0 3px rgba(255, 213, 79, 0.35);
}
.search-close{
  padding: 10px 12px;
  border-radius: 12px;
  border: 2px solid #eee;
  background: #fafafa;
  cursor: pointer;
}
.search-hint{
  margin-top: 8px;
  font-size: 12px;
  color: #666;
}

/* æ¡Œæ©Ÿä¹Ÿå¯ç”¨ï¼Œä½†è‹¥ä½ æƒ³åªçµ¦æ‰‹æ©Ÿé¡¯ç¤ºï¼Œè§£é™¤ä¸‹é¢è¨»è§£
@media (min-width: 769px){
  .nav-search{ display:none; }
}
*/


/* ===== å³ä¸Šè§’æ”¹ç‚ºã€Œå…§åµŒæœå°‹åˆ—ã€ ===== */
.main-nav{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
}
.header-left{ display:flex; align-items:center; min-width: 180px; }
.header-left h1{ margin:0; white-space:nowrap; }

.header-search{
  flex: 1;
  max-width: 520px;
  display:flex;
  align-items:center;
  gap: 8px;
  background: rgba(255,255,255,0.18);
  border: 1px solid rgba(255,255,255,0.28);
  border-radius: 14px;
  padding: 8px 10px;
}
.header-search-icon{ color:#fff; opacity:0.95; }
#headerSearchInput{
  flex: 1;
  border: none;
  background: transparent;
  color: #fff;
  outline: none;
  font-size: 16px;
}
#headerSearchInput::placeholder{ color: rgba(255,255,255,0.8); }
.header-search-clear{
  border: none;
  background: rgba(255,255,255,0.18);
  color: #fff;
  border-radius: 10px;
  padding: 6px 8px;
  cursor: pointer;
}
.header-search-clear:active{ transform: scale(0.98); }
.search-overlay{ display:none !important; }
@media (max-width: 768px){
  .header-left{ min-width:auto; }
  .header-left h1{ font-size:1.05rem; }
  .header-search{ max-width:none; padding:6px 8px; border-radius: 12px; }
}

/* æ–°å“ toggle switchï¼ˆå•†å“ç®¡ç†ç”¨ï¼‰ */
.switch{ position: relative; display:inline-block; width: 44px; height: 24px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; cursor:pointer; inset:0; background:#ccc; transition:.2s; border-radius: 999px; }
.slider:before{ position:absolute; content:""; height:18px; width:18px; left:3px; top:3px; background:white; transition:.2s; border-radius:50%; }
.switch input:checked + .slider{ background:#e53935; }
.switch input:checked + .slider:before{ transform: translateX(20px); }


/* ===== æ‰‹æ©Ÿç›´å¼ Header ä¿®æ­£ ===== */
@media (max-width: 600px){
  .header{
    gap:6px;
  }
  .header-search{
    max-width: none;
    flex: 1;
    min-width: 0;
    padding:6px 8px;
  }
  #headerSearchInput{
    font-size:14px;
  }
  .nav-toggle{
    flex-shrink:0;
  }
}


/* v1.7bï¼šå•†å“å¡ åç¨±+åƒ¹æ ¼ä¸Šä¸‹æ’ï¼ˆé¿å…åç¨±è¢«æ“ å£“ï¼‰ */
.product-vertical .product-name{
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.product-vertical .product-price{
  font-size: 18px;
  font-weight: 800;
  margin: 0 0 4px 0 !important;
}
.product-vertical .product-stock{
  font-size: 13px;
  margin: 0 !important;
  line-height: 1.15;
}


/* v1.7cï¼šå•†å“å¡æ›´ç·Šæ¹Šï¼ˆåº«å­˜èˆ‡åƒ¹æ ¼åŒä¸€è¡Œï¼‰ */
.product-compact .product-name{
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.product-compact .product-meta{
  display:flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 10px;
}
.product-compact .product-price{
  font-size: 18px;
  font-weight: 800;
  margin: 0 !important;
  line-height: 1.05;
}
.product-compact .product-stock{
  font-size: 13px;
  margin: 0 !important;
  line-height: 1.05;
  text-align: right;
  white-space: nowrap;
}


/* v1.7dï¼šå•†å“å¡æ›´ç·Šæ¹Šï¼ˆæ¶ˆæ‰ä½ åœˆçš„ç©ºç™½ï¼‰ */
.product-card{ position: relative; } /* è®“ NEW æ¨™ç±¤å¯å®šä½ */

.product-info{
  padding: 0.55rem 0.75rem 0.7rem !important; /* ä¸Šä¸‹æ›´ç·Š */
}

.product-compact .product-name{
  height: auto !important;          /* è¦†è“‹åŸæœ¬å›ºå®šé«˜åº¦ */
  margin-bottom: 6px !important;    /* åç¨±èˆ‡ä¸‹æ’æ›´ç·Š */
  line-height: 1.15;
  font-size: 1rem;
}

/* åƒ¹æ ¼ï¼‹åº«å­˜é‚£æ’å†ç·Šæ¹Šä¸€é» */
.product-compact .product-meta{
  gap: 8px;
}
.product-compact .product-price{
  line-height: 1.05;
}
.product-compact .product-stock{
  line-height: 1.05;
}

/* NEW è§’æ¨™ï¼ˆç´…åº•ç™½å­—æ–œè§’ï¼‰ */
.badge-new{
  position: absolute;
  top: 4px;        /* å†å¾€ä¸‹å…©é» */
  left: -40px;
  transform: rotate(-45deg);
  background: #e53935;
  color: #fff;
  font-weight: 800;
  font-size: 12px;
  padding: 4px 44px;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  z-index: 3;
  pointer-events: none;
}


.product-price{white-space:nowrap !important; word-break:keep-all !important;}
.product-stock{white-space:nowrap !important;}


        /* ===== å•†å“ç®¡ç†ç¯©é¸åˆ— ===== */
        .manage-filters{ margin: 0 0 1rem 0; background:#fff; border-radius:16px; padding:0.75rem 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .manage-filters .filter-row{ display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }
        .filter-select{ padding:0.55rem 0.8rem; border:2px solid rgba(99,102,241,0.35); border-radius:12px; font-size:0.95rem; background:#fff; min-width: 180px; }
        .filter-reset{ padding:0.55rem 0.9rem; border:none; border-radius:12px; font-size:0.95rem; background:#f1f5f9; color:#334155; cursor:pointer; }
        .filter-reset:hover{ background:#e2e8f0; }
        .manage-filters .filter-hint{ margin-top:0.55rem; font-size:0.86rem; color:#64748b; }
        @media (max-width: 600px){
            .filter-select{ min-width: 140px; flex: 1 1 140px; }
            .filter-reset{ flex: 0 0 auto; }
        }

        /* ===== åˆ†é¡/é¡å‹æ‹–æ›³æ’åº ===== */
        .ct-item{ display:flex; justify-content:space-between; align-items:center; gap:0.6rem; padding:0.55rem 0; border-bottom:1px solid #eee; }
        .ct-left{ display:flex; align-items:center; gap:0.6rem; min-width: 0; }
        .ct-handle{ cursor:grab; user-select:none; font-size:1.2rem; color:#94a3b8; padding:0.2rem 0.35rem; border-radius:8px; }
        .ct-handle:active{ cursor:grabbing; }
        .ct-label{ word-break:break-word; min-width:0; }
        .ct-item.dragging{ opacity:0.55; }
        .ct-item.drag-over{ background: rgba(99,102,241,0.08); }
        .ct-move{ display:flex; gap:0.4rem; }
        .btn-move{ background:#f1f5f9; border:none; border-radius:10px; padding:0.35rem 0.5rem; cursor:pointer; color:#334155; }
        .btn-move:hover{ background:#e2e8f0; }
</style>
</head>
<body>
    <!-- ä¸»å°èˆª -->
    <div class="main-nav">
        
        <div class="header-left"><h1>ğŸ›’ åŒäººå ´ POS ç³»çµ±</h1></div>

        <div class="header-search">
            <span class="header-search-icon">ğŸ”</span>
            <input id="headerSearchInput" type="search" placeholder="æœå°‹å•†å“â€¦" oninput="setNavSearch(this.value)">
            <button class="header-search-clear" type="button" onclick="clearHeaderSearch()" aria-label="æ¸…é™¤">âœ•</button>
        </div>

        <button class="nav-toggle" onclick="toggleMobileMenu()">â˜°</button>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showPage('sales', this)">éŠ·å”®</button>
            <button class="nav-btn" onclick="showPage('manage', this)">å•†å“ç®¡ç†</button>
            <button class="nav-btn" onclick="showPage('report', this)">å ±è¡¨</button>
            <button class="nav-btn" onclick="showPage('settings', this)">è¨­å®š</button>
        </div>
    </div>

    <div id="mobileMenu" class="mobile-menu">
        <button class="mobile-menu-btn" onclick="showPage('sales', this); toggleMobileMenu(false)">éŠ·å”®</button>
        <button class="mobile-menu-btn" onclick="showPage('manage', this); toggleMobileMenu(false)">å•†å“ç®¡ç†</button>
        <button class="mobile-menu-btn" onclick="showPage('report', this); toggleMobileMenu(false)">å ±è¡¨</button>
        <button class="mobile-menu-btn" onclick="showPage('settings', this); toggleMobileMenu(false)">è¨­å®š</button>
    </div>

    <!-- ========== éŠ·å”®é é¢ ========== -->
    <div id="page-sales" class="page active">
        <div class="sales-container">
            <!-- å·¦å´è³¼ç‰©è»Š -->
            <div class="cart-panel">
                <div class="cart-header">
                    è³¼ç‰©è»Š
                </div>
                <div class="cart-items" id="cartItems">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ›’</div>
                        <p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                    </div>
                </div>
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>å•†å“æ•¸é‡ï¼š</span>
                        <span id="cartCount">0</span>
                    </div>
                    <div class="summary-row total">
                        <span>ç¸½è¨ˆï¼š</span>
                        <span id="cartTotal">NT$ 0</span>
                    </div>
                </div>
                <div class="cart-actions">
                    <button class="btn btn-clear" onclick="clearCart()">æ¸…ç©º</button>
                    <button class="btn btn-checkout" id="checkoutBtn" onclick="openCheckout()" disabled>çµå¸³</button>
                </div>
            </div>

            <!-- å³å´å•†å“å±•ç¤º -->
            <div class="products-panel">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label">ä½œå“åˆ†é¡</label>
                        <div class="filter-buttons" id="categoryFilters">
                            <button class="filter-btn active" data-category="all">å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">å•†å“é¡å‹</label>
                        <div class="filter-buttons" id="typeFilters">
                            <button class="filter-btn active" data-type="all">å…¨éƒ¨</button>
                        </div>
                    </div>
                </div>
                <div class="products-grid" id="productsGrid">
                    <!-- å•†å“å¡ç‰‡æœƒå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ========== å•†å“ç®¡ç†é é¢ ========== -->
    <div id="page-manage" class="page">
        <div class="manage-container">
            <div class="manage-header">
                <h2>å•†å“ç®¡ç†</h2>
                <button class="btn-add" onclick="openProductModal()">â• æ–°å¢å•†å“</button>
            
            </div>
            <div class="manage-filters">
                <div class="filter-row">
                    <select id="manageFilterCategory" class="filter-select" onchange="onManageFilterChange()"></select>
                    <select id="manageFilterType" class="filter-select" onchange="onManageFilterChange()"></select>
                    <button class="filter-reset" onclick="resetManageFilters()">æ¸…é™¤ç¯©é¸</button>
                </div>
                <div class="filter-hint">æç¤ºï¼šå¯ç”¨åˆ†é¡/é¡å‹å¿«é€Ÿç¸®å°æ¸…å–®ï¼Œæ–¹ä¾¿å¤§é‡å•†å“ç®¡ç†ã€‚</div>
            </div>
            <div class="products-table">

                <table>
                    <thead>
                        <tr>
                            <th>åœ–ç‰‡</th>
                            <th>å•†å“åç¨±</th>
                            <th>ä½œå“åˆ†é¡</th>
                            <th>å•†å“é¡å‹</th>
                            <th>å”®åƒ¹</th>
                            <th>æˆæœ¬</th>
                            <th>åº«å­˜</th>
                    <th>æ–°å“</th>
<th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- å•†å“åˆ—è¡¨æœƒå‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== å ±è¡¨é é¢ ========== -->
    <div id="page-report" class="page">
        <div class="report-container">
            <h2 style="margin-bottom: 1.5rem;">éŠ·å”®å ±è¡¨</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥äº¤æ˜“ç­†æ•¸</div>
                    <div class="stat-value" id="statTransactions">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥ç‡Ÿæ”¶</div>
                    <div class="stat-value" id="statRevenue">NT$ 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥æˆæœ¬</div>
                    <div class="stat-value" id="statCost">NT$ 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥æ¯›åˆ©</div>
                    <div class="stat-value" id="statProfit">NT$ 0</div>
                </div>
            </div>

            <div class="transactions-list">
                <h3 style="margin-bottom: 1rem;">äº¤æ˜“æ˜ç´°</h3>
                <div id="transactionsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>å°šç„¡äº¤æ˜“è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== è¨­å®šé é¢ ========== -->
    <div id="page-settings" class="page">
        <div class="manage-container">
            <h2 style="margin-bottom: 1.5rem;">ç³»çµ±è¨­å®š</h2>
            
            <div class="gift-settings">
                <h3 style="margin-bottom: 1rem;">æ»¿é¡è´ˆè¨­å®š</h3>
                <div class="form-group">
                    <label class="form-label">å•Ÿç”¨æ»¿é¡è´ˆ</label>
                    <input type="checkbox" id="giftEnabled" onchange="saveGiftSettings()">
                </div>
                <div class="form-group">
                    <label class="form-label">æ»¿é¡é–€æª»ï¼ˆå…ƒï¼‰</label>
                    <input type="number" class="form-input" id="giftThreshold" value="1000" onchange="saveGiftSettings()">
                </div>
                <div class="form-group">
                    <label class="form-label">è´ˆå“èªªæ˜</label>
                    <input type="text" class="form-input" id="giftDescription" value="ç²¾ç¾å°å¡ä¸€å¼µ" onchange="saveGiftSettings()">
                </div>
            </div>

            <div class="gift-settings">
                <h3 style="margin-bottom: 1rem;">è³‡æ–™ç®¡ç†</h3>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn-add" onclick="exportData()">åŒ¯å‡ºæ‰€æœ‰è³‡æ–™</button>
                    <button class="btn-add" style="background: #ffa502;" onclick="document.getElementById('importFile').click()">åŒ¯å…¥è³‡æ–™</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn-add" style="background: #ff4757;" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>

            
            <div class="gift-settings">
                <h3 style="margin-bottom: 1rem;">åˆ†é¡ / é¡å‹ç®¡ç†</h3>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <!-- ä½œå“åˆ†é¡ -->
                    <div style="background:#fafafa; border:2px solid #eee; border-radius:12px; padding:1rem;">
                        <div style="font-weight:bold; margin-bottom:0.75rem;">ä½œå“åˆ†é¡</div>
                        <div style="display:flex; gap:0.5rem; margin-bottom:0.75rem;">
                            <input id="newCategoryInput" class="form-input" type="text" placeholder="æ–°å¢åˆ†é¡ï¼ˆä¾‹ï¼šåŸå‰µï¼‰">
                            <button class="btn-add" style="white-space:nowrap;" onclick="addCategory()">æ–°å¢</button>
                        </div>
                        <div id="categoryList"></div>
                        <div style="color:#666; font-size:0.9rem; margin-top:0.75rem;">
                            åˆªé™¤å‰æœƒæª¢æŸ¥æ˜¯å¦æœ‰å•†å“æ­£åœ¨ä½¿ç”¨è©²åˆ†é¡
                        </div>
                    </div>

                    <!-- å•†å“é¡å‹ -->
                    <div style="background:#fafafa; border:2px solid #eee; border-radius:12px; padding:1rem;">
                        <div style="font-weight:bold; margin-bottom:0.75rem;">å•†å“é¡å‹</div>
                        <div style="display:flex; gap:0.5rem; margin-bottom:0.75rem;">
                            <input id="newTypeInput" class="form-input" type="text" placeholder="æ–°å¢é¡å‹ï¼ˆä¾‹ï¼šæ˜ä¿¡ç‰‡ï¼‰">
                            <button class="btn-add" style="white-space:nowrap;" onclick="addType()">æ–°å¢</button>
                        </div>
                        <div id="typeList"></div>
                        <div style="color:#666; font-size:0.9rem; margin-top:0.75rem;">
                            åˆªé™¤å‰æœƒæª¢æŸ¥æ˜¯å¦æœ‰å•†å“æ­£åœ¨ä½¿ç”¨è©²é¡å‹
                        </div>
                    </div>
                </div>
            </div>

<div class="gift-settings">
                <h3 style="margin-bottom: 1rem;">ä½¿ç”¨èªªæ˜</h3>
                <p style="line-height: 1.8; color: #666;">
                    <strong>ğŸ›’ éŠ·å”®é é¢ï¼š</strong><br>
                    â€¢ é»æ“Šå•†å“å¡ç‰‡åŠ å…¥è³¼ç‰©è»Š<br>
                    â€¢ å¯èª¿æ•´æ•¸é‡æˆ–ç§»é™¤å•†å“<br>
                    â€¢ é»æ“Šã€Œçµå¸³ã€é€²è¡Œä»˜æ¬¾<br><br>
                    
                    <strong>ğŸ“¦ å•†å“ç®¡ç†ï¼š</strong><br>
                    â€¢ æ–°å¢å•†å“æ™‚å¯ä¸Šå‚³åœ–ç‰‡ï¼ˆæ”¯æ´æ‹–æ›³ä¸Šå‚³ï¼‰<br>
                    â€¢ è¨­å®šå•†å“åç¨±ã€åˆ†é¡ã€å”®åƒ¹ã€æˆæœ¬ã€åº«å­˜<br>
                    â€¢ ç·¨è¼¯æˆ–åˆªé™¤ç¾æœ‰å•†å“<br><br>
                    
                    <strong>ğŸ“Š å ±è¡¨ï¼š</strong><br>
                    â€¢ æŸ¥çœ‹ä»Šæ—¥éŠ·å”®çµ±è¨ˆ<br>
                    â€¢ æª¢è¦–äº¤æ˜“æ˜ç´°<br>
                    â€¢ è¿½è¹¤ç‡Ÿæ”¶èˆ‡æ¯›åˆ©<br><br>
                    
                    <strong>âš™ï¸ è¨­å®šï¼š</strong><br>
                    â€¢ è¨­å®šæ»¿é¡è´ˆæ´»å‹•<br>
                    â€¢ åŒ¯å‡º/åŒ¯å…¥è³‡æ–™å‚™ä»½<br>
                    â€¢ æ‰€æœ‰è³‡æ–™å„²å­˜åœ¨ç€è¦½å™¨æœ¬æ©Ÿï¼Œå¯é›¢ç·šä½¿ç”¨
                </p>
            </div>
        </div>
    </div>

    <!-- ========== å•†å“ç·¨è¼¯ Modal ========== -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°å¢å•†å“</div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <div class="form-group">
                    <label class="form-label">å•†å“åœ–ç‰‡</label>
                    <input type="file" class="form-input" id="productImage" accept="image/*" onchange="previewImage(event)">
                    <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
                        <input type="text" class="form-input" id="productImageUrl" placeholder="æˆ–è¼¸å…¥åœ–ç‰‡è·¯å¾‘ï¼ˆæ¨è–¦ï¼‰ï¼šimages/xxx.webp" oninput="setImageByUrl(this.value)">
                        <button type="button" class="btn-add" style="white-space:nowrap; padding:0.65rem 1rem;" onclick="openImageLibrary()">é¸åœ–ç‰‡</button>
                    </div>
                    <img id="imagePreview" class="image-preview" style="display: none;">
                    <input type="hidden" id="productImageData">
                </div>
                <div class="form-group">
                    <label class="form-label">å•†å“åç¨± *</label>
                    <input type="text" class="form-input" id="productName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ä½œå“åˆ†é¡ *</label>
                    <select class="form-select" id="productCategory" required>
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="BBX">BBX</option>
                        <option value="å¯¶å¯å¤¢">å¯¶å¯å¤¢</option>
                        <option value="å´©éµ">å´©éµ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å•†å“é¡å‹ *</label>
                    <select class="form-select" id="productType" required>
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="å–®å”®è²¼ç´™">å–®å”®è²¼ç´™</option>
                        <option value="è²¼ç´™åŒ…">è²¼ç´™åŒ…</option>
                        <option value="å£“å…‹åŠ›åŠé£¾">å£“å…‹åŠ›åŠé£¾</option>
                        <option value="å£“å…‹åŠ›ç«‹ç‰Œ">å£“å…‹åŠ›ç«‹ç‰Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å”®åƒ¹ï¼ˆå…ƒï¼‰*</label>
                    <input type="number" class="form-input" id="productPrice" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æˆæœ¬ï¼ˆå…ƒï¼‰*</label>
                    <input type="number" class="form-input" id="productCost" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">åº«å­˜æ•¸é‡ *</label>
                    <input type="number" class="form-input" id="productStock" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ–°å“æ¨™è¨˜</label>
                    <label style="display:flex;align-items:center;gap:10px;">
                        <input type="checkbox" id="productIsNew">
                        <span>é¡¯ç¤º NEW æ¨™ç±¤</span>
                    </label>
                </div>
                <input type="hidden" id="productId">
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeProductModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-save">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== çµå¸³ Modal ========== -->
    <div id="checkoutModal" class="modal checkout-modal">
        <div class="modal-content">
            <div class="modal-header">çµå¸³</div>
            
            <div class="checkout-summary">
                <div class="checkout-row">
                    <span>å•†å“æ•¸é‡ï¼š</span>
                    <span id="checkoutCount">0</span>
                </div>
                
            <div id="checkoutItems" class="checkout-items"></div>
<div class="checkout-row total">
                    <span>æ‡‰æ”¶é‡‘é¡ï¼š</span>
                    <span id="checkoutTotal">NT$ 0</span>
                </div>
            </div>

            <div id="giftNotice" class="gift-notice" style="display: none;">
                ğŸ æ­å–œï¼æœ¬æ¬¡æ¶ˆè²»æ»¿é¡ï¼Œè´ˆé€ï¼š<span id="giftText"></span>
            </div>

            <div class="form-group">
                <label class="form-label">æ”¶æ¬¾é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                <input type="number" class="form-input" id="receivedAmount" min="0" oninput="calculateChange()">
            </div>

            <div class="quick-cash">
                <button class="quick-cash-btn" onclick="setReceivedAmount(100)">100</button>
                <button class="quick-cash-btn" onclick="setReceivedAmount(500)">500</button>
                <button class="quick-cash-btn" onclick="setReceivedAmount(1000)">1000</button>
            </div>

            <div id="changeDisplay" class="change-display" style="display: none;">
                <div class="change-label">æ‰¾é›¶</div>
                <div class="change-amount" id="changeAmount">NT$ 0</div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeCheckout()">å–æ¶ˆ</button>
                <button type="button" class="btn-save" id="confirmCheckoutBtn" onclick="confirmCheckout()" disabled>ç¢ºèªä»˜æ¬¾</button>
            </div>
        </div>
    </div>


    <div id="imageLibraryModal" class="modal">
        <div class="modal-content" style="max-width: 860px;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <span>é¸æ“‡åœ–ç‰‡ï¼ˆimages/ï¼‰</span>
                <button type="button" class="btn-cancel" style="padding:0.5rem 0.8rem;" onclick="closeImageLibrary()">é—œé–‰</button>
            </div>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                <input id="imageLibrarySearch" class="form-input" type="search" placeholder="æœå°‹æª”åï¼ˆä¾‹ï¼šbbx / pkm / stickerï¼‰" oninput="renderImageLibrary()">
                <button type="button" class="btn-add" style="white-space:nowrap; padding:0.65rem 1rem;" onclick="reloadImageLibrary(true)">é‡æ–°è¼‰å…¥</button>
            </div>
            <div id="imageLibraryStatus" style="color:#666; font-size:0.9rem; margin-bottom:10px;"></div>
            <div id="imageLibraryGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;"></div>
            <div style="margin-top:12px; color:#666; font-size:0.9rem; line-height:1.6;">
                ä¾†æºï¼š<code>images.json</code>ï¼ˆæ¸…å–®ï¼‰ + <code>images/</code>ï¼ˆåœ–ç‰‡è³‡æ–™å¤¾ï¼‰ã€‚æ›´æ–°åœ–ç‰‡å¾Œè¨˜å¾—åŒæ­¥æ›´æ–° <code>images.json</code>ã€‚
            </div>
        </div>
    </div>

    <script>
        // ========== è³‡æ–™çµæ§‹ ==========
        let products = [];
        let cart = [];
        let transactions = [];
        let giftSettings = {
            enabled: false,
            threshold: 1000,
            description: 'ç²¾ç¾å°å¡ä¸€å¼µ'
        };

        // ========== åˆ†é¡/é¡å‹ï¼ˆå¯å¾Œå°ç®¡ç†ï¼‰ ==========
        let categoryOptions = ['BBX', 'å¯¶å¯å¤¢', 'å´©éµ'];
        let typeOptions = ['å–®å”®è²¼ç´™', 'è²¼ç´™åŒ…', 'å£“å…‹åŠ›åŠé£¾', 'å£“å…‹åŠ›ç«‹ç‰Œ'];
        let imageLibrary = [];
        let imageLibraryLoaded = false;

        async function reloadImageLibrary(force = false) {
            const statusEl = document.getElementById('imageLibraryStatus');
            if (!force && imageLibraryLoaded) return;
            try {
                if (statusEl) statusEl.textContent = 'è¼‰å…¥ä¸­â€¦';
                const res = await fetch('./images.json?v=' + Date.now(), { cache: 'no-store' });
                if (!res.ok) throw new Error('è®€å– images.json å¤±æ•—ï¼ˆHTTP ' + res.status + 'ï¼‰');
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error('images.json æ ¼å¼éŒ¯èª¤ï¼šéœ€è¦æ˜¯é™£åˆ—');

                const cleaned = [];
                const seen = new Set();
                for (const it of data) {
                    if (typeof it !== 'string') continue;
                    const v = it.trim();
                    if (!v || seen.has(v)) continue;
                    seen.add(v);
                    cleaned.push(v);
                }
                imageLibrary = cleaned;
                imageLibraryLoaded = true;
                if (statusEl) statusEl.textContent = `å·²è¼‰å…¥ ${imageLibrary.length} å¼µåœ–ç‰‡`;
                renderImageLibrary();
            } catch (err) {
                if (statusEl) statusEl.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + (err && err.message ? err.message : String(err));
                imageLibrary = [];
                imageLibraryLoaded = false;
                renderImageLibrary();
            }
        }

        function openImageLibrary() {
            const modal = document.getElementById('imageLibraryModal');
            if (!modal) return;
            modal.classList.add('active');
            reloadImageLibrary(false);
            renderImageLibrary();
        }
        function closeImageLibrary() {
            const modal = document.getElementById('imageLibraryModal');
            if (!modal) return;
            modal.classList.remove('active');
        }

        function renderImageLibrary() {
            const grid = document.getElementById('imageLibraryGrid');
            const qEl = document.getElementById('imageLibrarySearch');
            const statusEl = document.getElementById('imageLibraryStatus');
            if (!grid) return;

            const q = (qEl ? qEl.value : '').trim().toLowerCase();
            const list = q ? imageLibrary.filter(n => n.toLowerCase().includes(q)) : imageLibrary;

            if (!imageLibraryLoaded) {
                grid.innerHTML = `<div style="grid-column:1/-1; color:#999; padding:10px;">å°šæœªè¼‰å…¥åœ–åº«ï¼ˆè«‹ç¢ºèª repo æ ¹ç›®éŒ„å­˜åœ¨ images.jsonï¼‰</div>`;
                return;
            }
            if (list.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; color:#999; padding:10px;">æ²’æœ‰ç¬¦åˆçš„åœ–ç‰‡</div>`;
                if (statusEl) statusEl.textContent = `å·²è¼‰å…¥ ${imageLibrary.length} å¼µåœ–ç‰‡ï¼ˆç›®å‰ç¯©é¸ 0ï¼‰`;
                return;
            }
            if (statusEl) statusEl.textContent = `å·²è¼‰å…¥ ${imageLibrary.length} å¼µåœ–ç‰‡ï¼ˆç›®å‰ç¯©é¸ ${list.length}ï¼‰`;

            grid.innerHTML = list.map(name => {
                const safe = escapeHtml(name);
                const src = 'images/' + safe;
                return `
                    <button type="button" onclick="selectImageFromLibrary('${escapeJs(name)}')" style="border:2px solid #eee;border-radius:12px;background:#fff;padding:8px;cursor:pointer;text-align:left;">
                        <img src="${src}" alt="${safe}" style="width:100%;height:110px;object-fit:cover;border-radius:10px;background:#f0f0f0;">
                        <div style="margin-top:6px;font-size:12px;color:#333;word-break:break-all;">${safe}</div>
                    </button>
                `;
            }).join('');
        }

        function selectImageFromLibrary(fileName) {
            const path = 'images/' + fileName;
            const urlInput = document.getElementById('productImageUrl');
            if (urlInput) urlInput.value = path;
            setImageByUrl(path);
            closeImageLibrary();
        }

        function setImageByUrl(url) {
            const v = (url || '').trim();
            const preview = document.getElementById('imagePreview');
            const hidden = document.getElementById('productImageData');
            if (!hidden || !preview) return;
            if (!v) {
                hidden.value = '';
                preview.style.display = 'none';
                return;
            }
            hidden.value = v;
            preview.src = v;
            preview.style.display = 'block';
        }


        function loadCategoryTypeOptions() {
            const c = localStorage.getItem('pos_categories');
            const t = localStorage.getItem('pos_types');
            if (c) categoryOptions = JSON.parse(c);
            if (t) typeOptions = JSON.parse(t);
        }

        function saveCategoryTypeOptions() {
            localStorage.setItem('pos_categories', JSON.stringify(categoryOptions));
            localStorage.setItem('pos_types', JSON.stringify(typeOptions));
        }

        function escapeHtml(s) {
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function escapeJs(s) {
            return String(s)
                .replaceAll('\\', '\\\\')
                .replaceAll("'", "\\'")
                .replaceAll('"', '\\"');
        }

        // å°‡é¸é …å¥—ç”¨åˆ°ã€Œå•†å“è¡¨å–®ã€ä¸‹æ‹‰
        function applyCategoryTypeToForm() {
            const catSelect = document.getElementById('productCategory');
            const typeSelect = document.getElementById('productType');
            if (!catSelect || !typeSelect) return;

            const catValue = catSelect.value;
            const typeValue = typeSelect.value;

            catSelect.innerHTML =
                `<option value="">è«‹é¸æ“‡</option>` +
                categoryOptions.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');

            typeSelect.innerHTML =
                `<option value="">è«‹é¸æ“‡</option>` +
                typeOptions.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');

            if (categoryOptions.includes(catValue)) catSelect.value = catValue;
            if (typeOptions.includes(typeValue)) typeSelect.value = typeValue;
        }

        // è¨­å®šé æ¸…å–®æ¸²æŸ“
        function renderCategoryTypeManager() {
            const catList = document.getElementById('categoryList');
            const typeList = document.getElementById('typeList');
            if (!catList || !typeList) return;

            catList.innerHTML = categoryOptions.map((c, idx) => `
                <div class="ct-item" draggable="true" data-kind="category" data-value="${c}">
                    <div class="ct-left">
                        <span class="ct-handle" title="æ‹–æ›³æ’åº">â‰¡</span>
                        <span class="ct-label">${c}</span>
                    </div>
                    <div class="ct-move">
                        <button class="btn-move" title="ä¸Šç§»" onclick="moveCategory('${c}', -1)">â†‘</button>
                        <button class="btn-move" title="ä¸‹ç§»" onclick="moveCategory('${c}', 1)">â†“</button>
                        <div class="category-actions">
                            <button class="btn-rename" onclick="renameCategory('${c}')">æ”¹å</button>
                            <button class="btn-delete" onclick="deleteCategory('${c}')">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');

            typeList.innerHTML = typeOptions.map((t, idx) => `
                <div class="ct-item" draggable="true" data-kind="type" data-value="${t}">
                    <div class="ct-left">
                        <span class="ct-handle" title="æ‹–æ›³æ’åº">â‰¡</span>
                        <span class="ct-label">${t}</span>
                    </div>
                    <div class="ct-move">
                        <button class="btn-move" title="ä¸Šç§»" onclick="moveType('${t}', -1)">â†‘</button>
                        <button class="btn-move" title="ä¸‹ç§»" onclick="moveType('${t}', 1)">â†“</button>
                        <div class="category-actions">
                            <button class="btn-rename" onclick="renameType('${t}')">æ”¹å</button>
                            <button class="btn-delete" onclick="deleteType('${t}')">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');

            initSortableList(catList, 'category');
            initSortableList(typeList, 'type');

            refreshCategoryTypeSelects();

            // åŒæ­¥æ›´æ–°é¦–é ç¯©é¸èˆ‡å•†å“ç®¡ç†ç¯©é¸
            renderFilters();
            renderManageFilters();
        }

                // ===== åˆ†é¡/é¡å‹ï¼šæ‹–æ›³æ’åº + ä¸Šä¸‹ç§» =====
        function moveCategory(name, delta) {
            const i = categoryOptions.indexOf(name);
            if (i === -1) return;
            const j = i + delta;
            if (j < 0 || j >= categoryOptions.length) return;
            const tmp = categoryOptions[i];
            categoryOptions[i] = categoryOptions[j];
            categoryOptions[j] = tmp;
            saveCategoryTypeOptions();
            renderCategoryTypeManager();
        }

        function moveType(name, delta) {
            const i = typeOptions.indexOf(name);
            if (i === -1) return;
            const j = i + delta;
            if (j < 0 || j >= typeOptions.length) return;
            const tmp = typeOptions[i];
            typeOptions[i] = typeOptions[j];
            typeOptions[j] = tmp;
            saveCategoryTypeOptions();
            renderCategoryTypeManager();
        }

        function initSortableList(container, kind) {
            if (!container) return;

            // æ¯æ¬¡é‡ç¹ªå¾Œï¼Œå…ˆç§»é™¤èˆŠçš„äº‹ä»¶å†ç¶ä¸€æ¬¡ï¼ˆç”¨ cloneNode æ–¹å¼é¿å…é‡è¤‡ç¶å®šï¼‰
            const newNode = container.cloneNode(true);
            container.parentNode.replaceChild(newNode, container);
            container = newNode;

            let dragEl = null;

            container.addEventListener('dragstart', (e) => {
                const item = e.target.closest('.ct-item');
                if (!item) return;
                dragEl = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.dataset.value || '');
                e.dataTransfer.setData('kind', kind);
            });

            container.addEventListener('dragend', (e) => {
                const item = e.target.closest('.ct-item');
                if (item) item.classList.remove('dragging');
                [...container.querySelectorAll('.ct-item')].forEach(el => el.classList.remove('drag-over'));
                dragEl = null;
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const over = e.target.closest('.ct-item');
                if (!over || over === dragEl) return;
                [...container.querySelectorAll('.ct-item')].forEach(el => el.classList.remove('drag-over'));
                over.classList.add('drag-over');
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const over = e.target.closest('.ct-item');
                if (!over || !dragEl) return;

                const fromValue = dragEl.dataset.value;
                const toValue = over.dataset.value;
                if (!fromValue || !toValue || fromValue === toValue) return;

                const arr = (kind === 'category') ? categoryOptions : typeOptions;
                const fromIndex = arr.indexOf(fromValue);
                const toIndex = arr.indexOf(toValue);
                if (fromIndex === -1 || toIndex === -1) return;

                // é‡æ–°æ’åº
                arr.splice(fromIndex, 1);
                arr.splice(toIndex, 0, fromValue);

                saveCategoryTypeOptions();
                renderCategoryTypeManager();
            });
        }

function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const v = (input.value || '').trim();
            if (!v) return;
            if (categoryOptions.includes(v)) return alert('æ­¤åˆ†é¡å·²å­˜åœ¨');
            categoryOptions.push(v);
            saveCategoryTypeOptions();
            renderCategoryTypeManager();
            applyCategoryTypeToForm();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
            input.value = '';
        }

        function addType() {
            const input = document.getElementById('newTypeInput');
            const v = (input.value || '').trim();
            if (!v) return;
            if (typeOptions.includes(v)) return alert('æ­¤é¡å‹å·²å­˜åœ¨');
            typeOptions.push(v);
            saveCategoryTypeOptions();
            renderCategoryTypeManager();
            applyCategoryTypeToForm();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
            input.value = '';
        }

        function renameCategory(oldName) {
            const nextName = (prompt('è«‹è¼¸å…¥æ–°åˆ†é¡åç¨±ï¼š', oldName) || '').trim();
            if (!nextName || nextName === oldName) return;
            if (categoryOptions.includes(nextName)) return alert('æ­¤åˆ†é¡å·²å­˜åœ¨');

            products.forEach(p => { if (p.category === oldName) p.category = nextName; });

            categoryOptions = categoryOptions.map(v => v === oldName ? nextName : v);
            saveCategoryTypeOptions();
            saveData();

            renderCategoryTypeManager();
            applyCategoryTypeToForm();
            renderProducts();
            renderProductsTable();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
        }

        function renameType(oldName) {
            const nextName = (prompt('è«‹è¼¸å…¥æ–°é¡å‹åç¨±ï¼š', oldName) || '').trim();
            if (!nextName || nextName === oldName) return;
            if (typeOptions.includes(nextName)) return alert('æ­¤é¡å‹å·²å­˜åœ¨');

            products.forEach(p => { if (p.type === oldName) p.type = nextName; });

            typeOptions = typeOptions.map(v => v === oldName ? nextName : v);
            saveCategoryTypeOptions();
            saveData();

            renderCategoryTypeManager();
            applyCategoryTypeToForm();
            renderProducts();
            renderProductsTable();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
        }

        function deleteCategory(name) {
            const used = products.some(p => p.category === name);
            if (used) return alert('æœ‰å•†å“æ­£åœ¨ä½¿ç”¨æ­¤åˆ†é¡ï¼Œè«‹å…ˆæ”¹æ‰å•†å“åˆ†é¡å†åˆªé™¤');
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${name}ã€ï¼Ÿ`)) return;

            categoryOptions = categoryOptions.filter(v => v !== name);
            saveCategoryTypeOptions();
            renderCategoryTypeManager();
            applyCategoryTypeToForm();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
        }

        function deleteType(name) {
            const used = products.some(p => p.type === name);
            if (used) return alert('æœ‰å•†å“æ­£åœ¨ä½¿ç”¨æ­¤é¡å‹ï¼Œè«‹å…ˆæ”¹æ‰å•†å“é¡å‹å†åˆªé™¤');
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¡å‹ã€Œ${name}ã€ï¼Ÿ`)) return;

            typeOptions = typeOptions.filter(v => v !== name);
            saveCategoryTypeOptions();
            renderCategoryTypeManager();
            applyCategoryTypeToForm();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
        }



        // ========== åˆå§‹åŒ– ==========
        function init() {

            reloadImageLibrary(false);
loadData();
            loadGiftSettings();

            loadCategoryTypeOptions();
            renderCategoryTypeManager();
            applyCategoryTypeToForm();

            renderProducts();
            renderProductsTable();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
            updateCart();
            renderReport();

            // è¼‰å…¥æ»¿é¡è´ˆè¨­å®š
            document.getElementById('giftEnabled').checked = giftSettings.enabled;
            document.getElementById('giftThreshold').value = giftSettings.threshold;
            document.getElementById('giftDescription').value = giftSettings.description;
        }

        // ========== è³‡æ–™æŒä¹…åŒ– ==========
        function saveData() {
            localStorage.setItem('pos_products', JSON.stringify(products));
            localStorage.setItem('pos_transactions', JSON.stringify(transactions));
        }

        function loadData() {
            const savedProducts = localStorage.getItem('pos_products');
            const savedTransactions = localStorage.getItem('pos_transactions');
            
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            }
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
        }

        function saveGiftSettings() {
            giftSettings = {
                enabled: document.getElementById('giftEnabled').checked,
                threshold: parseInt(document.getElementById('giftThreshold').value) || 1000,
                description: document.getElementById('giftDescription').value
            };
            localStorage.setItem('pos_gift_settings', JSON.stringify(giftSettings));
        }

        function loadGiftSettings() {
            const saved = localStorage.getItem('pos_gift_settings');
            if (saved) {
                giftSettings = JSON.parse(saved);
            }
        }

        // ========== é é¢åˆ‡æ› ==========
        function showPage(pageName, btnEl = null) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById('page-' + pageName).classList.add('active');

            // æ¡Œæ©ŸæŒ‰éˆ•é«˜äº®
            if (btnEl && btnEl.classList && btnEl.classList.contains('nav-btn')) {
                btnEl.classList.add('active');
            } else {
                // æ‰‹æ©Ÿé¸å–®é»çš„ï¼Œä¹ŸåŒæ­¥é«˜äº®æ¡Œæ©Ÿåˆ—
                const map = { sales: 0, manage: 1, report: 2, settings: 3 };
                const idx = map[pageName];
                const btns = document.querySelectorAll('.nav-buttons .nav-btn');
                if (btns[idx]) btns[idx].classList.add('active');
            }

            if (pageName === 'manage') {
                renderManageFilters();
                renderProductsTable();
            }

            if (pageName === 'settings') {
                renderCategoryTypeManager();
            }

            if (pageName === 'report') {
                renderReport();
            }
        }

        function toggleMobileMenu(force) {
            const menu = document.getElementById('mobileMenu');
            if (!menu) return;
            const next = (typeof force === 'boolean') ? force : !menu.classList.contains('active');
            menu.classList.toggle('active', next);
        }

        function setNavSearch(value) {
            navSearchTerm = (value || '').trim();
            renderProducts();
        }

        // ========== å•†å“ç®¡ç† ==========
        function openProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            form.reset();
            const n0 = document.getElementById('productIsNew');
            if (n0) n0.checked = false;
            applyCategoryTypeToForm();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('productImageData').value = '';
            
                        const urlInput0 = document.getElementById('productImageUrl');
            if (urlInput0) urlInput0.value = '';
if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.querySelector('.modal-header').textContent = 'ç·¨è¼¯å•†å“';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productType').value = product.type;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productCost').value = product.cost;
                    document.getElementById('productStock').value = product.stock;
                    const n = document.getElementById('productIsNew');
                    if (n) n.checked = !!product.isNew;
                    
                    if (product.image) {
                        document.getElementById('imagePreview').src = product.image;
                        document.getElementById('imagePreview').style.display = 'block';
                        document.getElementById('productImageData').value = product.image;
                        const urlInput = document.getElementById('productImageUrl');
                        if (urlInput) urlInput.value = product.image;
                    }
                }
            } else {
                document.querySelector('.modal-header').textContent = 'æ–°å¢å•†å“';
                document.getElementById('productId').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('productImageData').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveProduct(event) {
            event.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const productData = {
                id: productId || Date.now().toString(),
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                type: document.getElementById('productType').value,
                price: parseInt(document.getElementById('productPrice').value),
                cost: parseInt(document.getElementById('productCost').value),
                stock: parseInt(document.getElementById('productStock').value),
                isNew: !!document.getElementById('productIsNew').checked,
                image: (document.getElementById('productImageData').value || document.getElementById('productImageUrl').value) || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" text-anchor="middle" dy=".3em" font-size="18"%3Eç„¡åœ–ç‰‡%3C/text%3E%3C/svg%3E'
            };
            
            if (productId) {
                const index = products.findIndex(p => p.id === productId);
                products[index] = productData;
            } else {
                products.push(productData);
            }
            
            saveData();
            renderProducts();
            renderProductsTable();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
            closeProductModal();
        }

        function deleteProduct(productId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')) {
                products = products.filter(p => p.id !== productId);
                saveData();
                renderProducts();
                renderProductsTable();
                renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
            }
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');

            // ä¾ã€Œå•†å“ç®¡ç†ã€ç¯©é¸ï¼ˆä¸å½±éŸ¿é¦–é ç¯©é¸ï¼‰
            const mf = (window.manageFilters || { category: 'all', type: 'all' });
            const list = products.filter(p => {
                const catOk = (mf.category === 'all') || (p.category === mf.category);
                const typeOk = (mf.type === 'all') || (p.type === mf.type);
                return catOk && typeOk;
            });

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #999;">å°šç„¡å•†å“ï¼Œè«‹é»æ“Šã€Œæ–°å¢å•†å“ã€æŒ‰éˆ•</td></tr>';
                return;
            }

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #999;">ç›®å‰ç¯©é¸æ¢ä»¶æ²’æœ‰ç¬¦åˆçš„å•†å“</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(product => `
                <tr>
                    <td><img src="${product.image}" class="product-thumb"></td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.type}</td>
                    <td>NT$ ${product.price}</td>
                    <td>NT$ ${product.cost}</td>
                    <td>${product.stock}</td>
                    <td>${product.isNew ? '<span style="display:inline-block;background:#e53935;color:#fff;font-weight:800;font-size:12px;padding:2px 6px;border-radius:8px;">NEW</span>' : ''}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openProductModal('${product.id}')">ç·¨è¼¯</button>
                        <button class="action-btn btn-delete" onclick="deleteProduct('${product.id}')">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // ========== ç¯©é¸å™¨ ==========
        let currentFilters = {
            category: 'all',
            type: 'all'
        };

        // å•†å“ç®¡ç†é é¢å°ˆç”¨ç¯©é¸ï¼ˆèˆ‡é¦–é ç¯©é¸åˆ†é–‹ï¼‰
        window.manageFilters = { category: 'all', type: 'all' };

        // å³ä¸Šè§’æœå°‹ï¼ˆåç¨±åŒ…å«ï¼‰
        let navSearchTerm = '';

        function renderFilters() {
            const mergedMobile = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;

            const categories = ['all', ...categoryOptions];
            const types = typeOptions;

            const categoryFilters = document.getElementById('categoryFilters');
            categoryFilters.innerHTML = categories.map(cat => `
                <button class="filter-btn ${currentFilters.category === cat ? 'active' : ''}" 
                        data-category="${cat}" 
                        onclick="setFilter('category', '${escapeJs(cat)}')">
                    ${cat === 'all' ? 'å…¨éƒ¨' : escapeHtml(cat)}
                </button>
            `).join('');

            const typeFilters = document.getElementById('typeFilters');

            // æ–¹æ¡ˆAï¼ˆåˆä½µä¸€æ’tagï¼‰ï¼šé¿å…å‡ºç¾ç¬¬äºŒå€‹ã€Œå…¨éƒ¨ã€
            if (mergedMobile) {
                types = types.filter(t => t !== 'all');
            }
            typeFilters.innerHTML = types.map(type => `
                <button class="filter-btn ${currentFilters.type === type ? 'active' : ''}" 
                        data-type="${type}" 
                        onclick="setFilter('type', '${escapeJs(type)}')">
                    ${type === 'all' ? 'å…¨éƒ¨' : escapeHtml(type)}
                </button>
            `).join('');
        }

                // ===== å•†å“ç®¡ç†é é¢ï¼šåˆ†é¡/é¡å‹ç¯©é¸ =====
        function renderManageFilters() {
            const selCat = document.getElementById('manageFilterCategory');
            const selType = document.getElementById('manageFilterType');
            if (!selCat || !selType) return;

            // å…ˆè¨˜ä½ç›®å‰å€¼ï¼ˆé¿å…é‡ç¹ªè·³å›ï¼‰
            const curCat = (window.manageFilters && window.manageFilters.category) ? window.manageFilters.category : 'all';
            const curType = (window.manageFilters && window.manageFilters.type) ? window.manageFilters.type : 'all';

            const catList = ['all', ...categoryOptions];
            const typeList = ['all', ...typeOptions];

            selCat.innerHTML = catList.map(v => {
                const label = (v === 'all') ? 'å…¨éƒ¨åˆ†é¡' : v;
                return `<option value="${v}" ${v === curCat ? 'selected' : ''}>${label}</option>`;
            }).join('');

            selType.innerHTML = typeList.map(v => {
                const label = (v === 'all') ? 'å…¨éƒ¨é¡å‹' : v;
                return `<option value="${v}" ${v === curType ? 'selected' : ''}>${label}</option>`;
            }).join('');
        }

        function onManageFilterChange() {
            const selCat = document.getElementById('manageFilterCategory');
            const selType = document.getElementById('manageFilterType');
            if (!selCat || !selType) return;

            window.manageFilters = window.manageFilters || { category: 'all', type: 'all' };
            window.manageFilters.category = selCat.value || 'all';
            window.manageFilters.type = selType.value || 'all';
            renderProductsTable();
        }

        function resetManageFilters() {
            window.manageFilters = { category: 'all', type: 'all' };
            renderManageFilters();
            renderProductsTable();
        }

function setFilter(filterType, value) {
            currentFilters[filterType] = value;
            renderProducts();
            renderFilters();
            const hs = document.getElementById('headerSearchInput');
            if (hs) hs.value = navSearchTerm || '';
        }

        // ========== å•†å“å±•ç¤º ==========
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            let filtered = products;
            if (currentFilters.category !== 'all') {
                filtered = filtered.filter(p => p.category === currentFilters.category);
            }
            if (currentFilters.type !== 'all') {
                filtered = filtered.filter(p => p.type === currentFilters.type);
            }
            if (navSearchTerm) {
                const q = navSearchTerm.toLowerCase();
                filtered = filtered.filter(p => (p.name || '').toLowerCase().includes(q));
            }
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><p>æ²’æœ‰ç¬¦åˆæ¢çš„å•†å“</p></div>';
                return;
            }
            
            grid.innerHTML = filtered.map(product => `
                <div class="product-card ${product.stock === 0 ? 'out-of-stock' : ''}" 
                     onclick="${product.stock > 0 ? `addToCart('${product.id}')` : ''}">
                    ${product.isNew ? `<div class="badge-new">NEW</div>` : ``}
                    <img src="${product.image}" class="product-image">
                    <div class="product-info product-compact">
                        <div class="product-name">${product.name}</div>
                        <div class="product-meta">
                            <div class="product-price">NT$Â ${product.price}</div>
                            <div class="product-stock ${product.stock <= 5 ? 'low' : ''}">
                                åº«å­˜ï¼š${product.stock === 0 ? 'å®Œå”®' : product.stock + ' '}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========== è³¼ç‰©è»Š ==========
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // åŠ å…¥è³¼ç‰©è»Šå³ã€Œä¿ç•™åº«å­˜ã€ï¼šé»ä¸€æ¬¡å…ˆæ‰£ä¸€æ¬¡åº«å­˜
            if (product.stock <= 0) return;

            const existingItem = cart.find(item => item.productId === productId);

            // å…ˆæ‰£åº«å­˜ï¼ˆä¿ç•™ï¼‰
            product.stock -= 1;

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    productId: productId,
                    name: product.name,
                    price: product.price,
                    cost: product.cost,
                    quantity: 1
                });
            }

            saveData();
            updateCart();
            renderProducts();
            renderProductsTable();
        }

        function updateCartItem(productId, delta) {
            const item = cart.find(item => item.productId === productId);
            if (!item) return;

            const product = products.find(p => p.id === productId);
            if (!product) return;

            if (delta > 0) {
                // åŠ ä¸€ï¼šé‚„æœ‰åº«å­˜æ‰èƒ½åŠ ï¼Œä¸¦ä¸”ç«‹åˆ»æ‰£åº«å­˜
                if (product.stock <= 0) return;
                product.stock -= 1;
                item.quantity += 1;
            } else if (delta < 0) {
                // æ¸›ä¸€ï¼šæŠŠåº«å­˜åŠ å›å»
                item.quantity -= 1;
                product.stock += 1;

                if (item.quantity <= 0) {
                    cart = cart.filter(ci => ci.productId !== productId);
                }
            }

            saveData();
            updateCart();
            renderProducts();
            renderProductsTable();
        }

        function removeFromCart(productId) {
            const item = cart.find(ci => ci.productId === productId);
            if (!item) return;

            const product = products.find(p => p.id === productId);
            if (product) {
                // æŠŠä¿ç•™çš„åº«å­˜ä¸€æ¬¡åŠ å›å»
                product.stock += item.quantity;
            }

            cart = cart.filter(ci => ci.productId !== productId);

            saveData();
            updateCart();
            renderProducts();
            renderProductsTable();
        }

        function clearCart() {
            if (cart.length > 0 && confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
                // æ¸…ç©ºå‰æŠŠæ‰€æœ‰ä¿ç•™åº«å­˜åŠ å›å»
                cart.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) product.stock += item.quantity;
                });

                cart = [];
                saveData();
                updateCart();
                renderProducts();
                renderProductsTable();
            }
        }

        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const cartTotal = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ›’</div><p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p></div>';
                cartCount.textContent = '0';
                cartTotal.textContent = 'NT$ 0';
                checkoutBtn.disabled = true;
                return;
            }
            
            const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">NT$ ${item.price} Ã— ${item.quantity}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="qty-btn" onclick="updateCartItem('${item.productId}', -1)">-</button>
                        <span class="cart-item-qty">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateCartItem('${item.productId}', 1)">+</button>
                        <button class="remove-btn" onclick="removeFromCart('${item.productId}')">ç§»é™¤</button>
                    </div>
                </div>
            `).join('');
            
            cartCount.textContent = totalCount;
            cartTotal.textContent = `NT$ ${totalAmount.toLocaleString()}`;
            checkoutBtn.disabled = false;
        }

        // ========== çµå¸³ ==========
        function openCheckout() {
            if (cart.length === 0) return;
            
            const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('checkoutCount').textContent = totalCount;
            document.getElementById('checkoutTotal').textContent = `NT$ ${totalAmount.toLocaleString()}`;
            document.getElementById('receivedAmount').value = '';
            document.getElementById('changeDisplay').style.display = 'none';
            document.getElementById('confirmCheckoutBtn').disabled = true;
            
            
            // çµå¸³æ˜ç´°ï¼ˆåƒç™¼ç¥¨ï¼‰ï¼šåœ¨çµå¸³å½ˆçª—é¡¯ç¤ºè³¼è²·é …ç›®
            const checkoutItemsBox = document.getElementById('checkoutItems');
            if (checkoutItemsBox) {
                checkoutItemsBox.innerHTML = cart.map(item => {
                    const lineTotal = item.price * item.quantity;
                    return `
                        <div class="checkout-item-row">
                            <div>
                                <div class="checkout-item-name">${item.name}</div>
                                <div class="checkout-item-sub">NT$ ${item.price} Ã— ${item.quantity}</div>
                            </div>
                            <div>NT$ ${lineTotal.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            }
// æª¢æŸ¥æ˜¯å¦é”åˆ°æ»¿é¡è´ˆé–€æª»
            const giftNotice = document.getElementById('giftNotice');
            if (giftSettings.enabled && totalAmount >= giftSettings.threshold) {
                giftNotice.style.display = 'block';
                document.getElementById('giftText').textContent = giftSettings.description;
            } else {
                giftNotice.style.display = 'none';
            }
            
            document.getElementById('checkoutModal').classList.add('active');
        }

        function closeCheckout() {
            document.getElementById('checkoutModal').classList.remove('active');
        }

        function setReceivedAmount(amount) {
            document.getElementById('receivedAmount').value = amount;
            calculateChange();
        }

        function calculateChange() {
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const received = parseInt(document.getElementById('receivedAmount').value) || 0;
            const change = received - totalAmount;
            
            const changeDisplay = document.getElementById('changeDisplay');
            const changeAmount = document.getElementById('changeAmount');
            const confirmBtn = document.getElementById('confirmCheckoutBtn');
            
            if (received >= totalAmount && received > 0) {
                changeDisplay.style.display = 'block';
                changeAmount.textContent = `NT$ ${change.toLocaleString()}`;
                confirmBtn.disabled = false;
            } else {
                changeDisplay.style.display = 'none';
                confirmBtn.disabled = true;
            }
        }

        function confirmCheckout() {
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalCost = cart.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
            const received = parseInt(document.getElementById('receivedAmount').value);
            const change = received - totalAmount;
            
            // å»ºç«‹äº¤æ˜“è¨˜éŒ„
            const transaction = {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                items: [...cart],
                totalAmount: totalAmount,
                totalCost: totalCost,
                profit: totalAmount - totalCost,
                received: received,
                change: change,
                gift: giftSettings.enabled && totalAmount >= giftSettings.threshold ? giftSettings.description : null
            };
            
            transactions.push(transaction);
            // åº«å­˜å·²åœ¨ã€ŒåŠ å…¥è³¼ç‰©è»Š / èª¿æ•´æ•¸é‡ã€æ™‚å…ˆæ‰£é™¤ï¼ˆä¿ç•™ï¼‰ï¼Œæ­¤è™•ä¸å†é‡è¤‡æ‰£åº«å­˜
saveData();
            
            // æ¸…ç©ºè³¼ç‰©è»Š
            cart = [];
            updateCart();
            
            // é‡æ–°æ¸²æŸ“å•†å“ï¼ˆæ›´æ–°åº«å­˜é¡¯ç¤ºï¼‰
            renderProducts();
            renderProductsTable();
            
            closeCheckout();
            
            alert(`âœ… äº¤æ˜“å®Œæˆï¼\næ‡‰æ”¶ï¼šNT$ ${totalAmount.toLocaleString()}\nå¯¦æ”¶ï¼šNT$ ${received.toLocaleString()}\næ‰¾é›¶ï¼šNT$ ${change.toLocaleString()}${transaction.gift ? '\n\nğŸ ' + transaction.gift : ''}`);
        }

        // ========== å ±è¡¨ ==========
        function renderReport() {
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => 
                new Date(t.timestamp).toDateString() === today
            );
            
            const totalTransactions = todayTransactions.length;
            const totalRevenue = todayTransactions.reduce((sum, t) => sum + t.totalAmount, 0);
            const totalCost = todayTransactions.reduce((sum, t) => sum + t.totalCost, 0);
            const totalProfit = totalRevenue - totalCost;
            
            document.getElementById('statTransactions').textContent = totalTransactions;
            document.getElementById('statRevenue').textContent = `NT$ ${totalRevenue.toLocaleString()}`;
            document.getElementById('statCost').textContent = `NT$ ${totalCost.toLocaleString()}`;
            document.getElementById('statProfit').textContent = `NT$ ${totalProfit.toLocaleString()}`;
            
            const transactionsList = document.getElementById('transactionsList');
            
            if (todayTransactions.length === 0) {
                transactionsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>å°šç„¡äº¤æ˜“è¨˜éŒ„</p></div>';
                return;
            }
            
            transactionsList.innerHTML = todayTransactions.reverse().map(transaction => {
                const time = new Date(transaction.timestamp).toLocaleTimeString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const itemsText = transaction.items.map(item => 
                    `${item.name} Ã— ${item.quantity}`
                ).join('ã€');
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-header">
                            <span class="transaction-time">${time}</span>
                            <span class="transaction-total">NT$ ${transaction.totalAmount.toLocaleString()}</span>
                        </div>
                        <div class="transaction-items">${itemsText}</div>
                        ${transaction.gift ? `<div style="color: #ffa502; font-size: 0.85rem; margin-top: 0.25rem;">ğŸ ${transaction.gift}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ========== è³‡æ–™åŒ¯å‡º/åŒ¯å…¥ ==========
        function exportData() {
            // åŒ¯å‡ºï¼šå•†å“ã€äº¤æ˜“ã€è´ˆå“è¨­å®šã€åˆ†é¡/é¡å‹æ¸…å–®ï¼ˆå«æ’åºï¼‰
            const data = {
                version: "pos_export_v2",
                exportDate: new Date().toISOString(),
                products: products || [],
                transactions: transactions || [],
                giftSettings: giftSettings || {},
                categoryOptions: categoryOptions || [],
                typeOptions: typeOptions || []
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `doujin-pos-data-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!confirm('åŒ¯å…¥è³‡æ–™æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                        event.target.value = '';
                        return;
                    }

                    // 1) å…ˆé‚„åŸåˆ†é¡/é¡å‹ï¼ˆé¿å…é¦–é ç¯©é¸åˆ—æ¶ˆå¤±ï¼‰
                    if (Array.isArray(data.categoryOptions)) {
                        categoryOptions = data.categoryOptions.filter(Boolean);
                    }
                    if (Array.isArray(data.typeOptions)) {
                        typeOptions = data.typeOptions.filter(Boolean);
                    }
                    // èˆŠç‰ˆç›¸å®¹ï¼šå¯èƒ½ç”¨ categories/types å‘½å
                    if (!Array.isArray(data.categoryOptions) && Array.isArray(data.categories)) {
                        categoryOptions = data.categories.filter(Boolean);
                    }
                    if (!Array.isArray(data.typeOptions) && Array.isArray(data.types)) {
                        typeOptions = data.types.filter(Boolean);
                    }

                    // å¦‚æœå®Œå…¨æ²’æœ‰ï¼Œå°±ä¿åº•ä¸€ä»½ï¼ˆé¿å… UI ç©ºç™½ï¼‰
                    if (!Array.isArray(categoryOptions) || categoryOptions.length === 0) {
                        categoryOptions = ['BBX', 'å¯¶å¯å¤¢', 'å´©éµ', 'å…¶ä»–'];
                    }
                    if (!Array.isArray(typeOptions) || typeOptions.length === 0) {
                        typeOptions = ['å–®å”®è²¼ç´™', 'è²¼ç´™åŒ…', 'å£“å…‹åŠ›åŠé£¾', 'å£“å…‹åŠ›ç«‹ç‰Œ', 'å…¶ä»–'];
                    }

                    saveCategoryTypeOptions();

                    // 2) é‚„åŸå•†å“/äº¤æ˜“/è´ˆå“è¨­å®šï¼ˆä¸¦åšè³‡æ–™ä¿®å¾©ï¼‰
                    const rawProducts = Array.isArray(data.products) ? data.products : [];
                    products = rawProducts.map(p => {
                        const obj = (p && typeof p === 'object') ? p : {};

                        // æ¬„ä½ç›¸å®¹ï¼šè‹¥èˆŠè³‡æ–™ç”¨åˆ¥çš„éµåï¼Œç›¡é‡è£œé½Š
                        const name = obj.name ?? obj.title ?? '';
                        const category = obj.category ?? obj.work ?? obj.series ?? obj.group ?? '';
                        const type = obj.type ?? obj.kind ?? obj.subtype ?? obj.itemType ?? '';
                        const price = Number.isFinite(Number(obj.price)) ? parseInt(obj.price) : 0;
                        const cost = Number.isFinite(Number(obj.cost)) ? parseInt(obj.cost) : 0;
                        const stock = Number.isFinite(Number(obj.stock)) ? parseInt(obj.stock) : 0;
                        const isNew = !!(obj.isNew ?? obj.new ?? obj.is_new);
                        const image = obj.image ?? obj.img ?? obj.imageUrl ?? obj.url ?? '';

                        return {
                            id: (obj.id ?? obj._id ?? Date.now().toString() + Math.random().toString(16).slice(2)),
                            name: String(name || '').trim(),
                            category: String(category || '').trim(),
                            type: String(type || '').trim(),
                            price: price,
                            cost: cost,
                            stock: stock,
                            isNew: isNew,
                            image: image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" text-anchor="middle" dy=".3em" font-size="18"%3Eç„¡åœ–ç‰‡%3C/text%3E%3C/svg%3E'
                        };
                    });

                    transactions = Array.isArray(data.transactions) ? data.transactions : [];
                    giftSettings = (data.giftSettings && typeof data.giftSettings === 'object') ? data.giftSettings : giftSettings;

                    saveData();
                    saveGiftSettings();

                    // 3) é‡å»ºç•«é¢ï¼ˆä¸è¦å› ç‚ºæš«å­˜ç‹€æ…‹å°è‡´é¦–é ç©ºç™½ï¼‰
                    //    init() æœƒ loadData()/loadCategoryTypeOptions()ï¼Œå› æ­¤è¦ç¢ºä¿å‰›æ‰å·² save*
                    init();

                    alert('åŒ¯å…¥å®Œæˆï¼');
                } catch (err) {
                    console.error(err);
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                } finally {
                    event.target.value = '';
                }
            }
            reader.readAsText(file);
        }

function clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šé€™æœƒæ¸…é™¤æ‰€æœ‰å•†å“ã€äº¤æ˜“è¨˜éŒ„ç­‰è³‡æ–™ï¼Œä¸”ç„¡æ³•å¾©åŸï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                if (confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                    localStorage.clear();
                    products = [];
                    cart = [];
                    transactions = [];
                    giftSettings = {
                        enabled: false,
                        threshold: 1000,
                        description: 'ç²¾ç¾å°å¡ä¸€å¼µ'
                    };
                    init();
                    alert('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼');
                }
            }
        }

        // ========== å•Ÿå‹•æ‡‰ç”¨ ==========
        window.onload = init;
    
        function clearHeaderSearch(){
            navSearchTerm = '';
            const input = document.getElementById('headerSearchInput');
            if (input) input.value = '';
            renderProducts();
        }

        function toggleProductNew(productId, isNew){
            const p = products.find(x => x.id === productId);
            if (!p) return;
            p.isNew = !!isNew;
            saveData();
            renderProducts();
            renderProductsTable();
        }
</script>
</body>
</html>